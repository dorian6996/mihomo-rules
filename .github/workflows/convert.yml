name: ZKEEN dat → MRS

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      GOPATH: ${{ github.workspace }}/.gopath
      GOBIN: ${{ github.workspace }}/.gopath/bin
      PATH: ${{ github.workspace }}/.gopath/bin:/usr/local/go/bin:${PATH}

    steps:
      - name: Checkout repo (force git, no REST API)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          clean: true
          submodules: false
          lfs: false
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.20"

      - name: Prepare Go path
        run: |
          mkdir -p "${GOPATH}/bin"

      - name: Build v2dat from source (urlesistiana)
        run: |
          set -euo pipefail
          git clone --depth 1 https://github.com/urlesistiana/v2dat.git v2dat-src
          cd v2dat-src/cmd/v2dat
          go build -o "${GOBIN}/v2dat" .
          "${GOBIN}/v2dat" --help | head -n 5

      - name: Install mihomo
        run: |
          set -euo pipefail
          go install github.com/metacubex/mihomo@latest
          mihomo version || true

      - name: Download ZKEEN dat files (ONLY releases)
        run: |
          set -euo pipefail
          mkdir -p tmp

          curl -fsS -L \
            -o tmp/zkeenip.dat \
            https://github.com/jameszeroX/zkeen-ip/releases/latest/download/zkeenip.dat

          curl -fsS -L \
            -o tmp/zkeen.dat \
            https://github.com/jameszeroX/zkeen-domains/releases/latest/download/zkeen.dat

          ls -lh tmp

      - name: Unpack GeoIP
        run: |
          mkdir -p tmp/geoip
          "${GOBIN}/v2dat" unpack -d tmp/geoip tmp/zkeenip.dat
          ls -lh tmp/geoip | head

      - name: Unpack GeoSite
        run: |
          mkdir -p tmp/geosite
          "${GOBIN}/v2dat" unpack -d tmp/geosite tmp/zkeen.dat
          ls -lh tmp/geosite | head

      - name: Convert GeoIP TXT → MRS
        run: |
          mkdir -p rules/geoip
          shopt -s nullglob || true
          for f in tmp/geoip/*.txt; do
            name=$(basename "$f" .txt)
            mihomo convert-ruleset ipcidr text "$f" "rules/geoip/$name.mrs" \
            || cp "$f" "rules/geoip/$name.txt"
          done

      - name: Convert GeoSite TXT → MRS
        run: |
          mkdir -p rules/geosite
          shopt -s nullglob || true
          for f in tmp/geosite/*.txt; do
            name=$(basename "$f" .txt)
            mihomo convert-ruleset domain text "$f" "rules/geosite/$name.mrs" \
            || cp "$f" "rules/geosite/$name.txt"
          done

      - name: Commit & Push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add rules || true
          if git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "Auto-update ZKEEN → MRS"
            git push || true
          fi
