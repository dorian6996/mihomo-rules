name: ZKEEN dat → MRS (manual v2dat build + mihomo)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GOPATH: ${{ runner.home }}/go
      PATH: /usr/local/go/bin:${{ runner.home }}/go/bin:${PATH}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y build-essential wget git ca-certificates unzip

      - name: Install Go
        run: |
          wget -q https://go.dev/dl/go1.22.5.linux-amd64.tar.gz -O /tmp/go.tgz
          sudo rm -rf /usr/local/go
          sudo tar -C /usr/local -xzf /tmp/go.tgz
          go version

      - name: Build v2dat from source
        run: |
          git clone https://github.com/urlesistiana/v2dat.git
          cd v2dat/cmd/v2dat
          go build -o $GOPATH/bin/v2dat .
          cd ../../..
          ls -l $GOPATH/bin/v2dat
          $GOPATH/bin/v2dat --help | head -n 10

      - name: Build mihomo from source
        run: |
          git clone https://github.com/metacubex/mihomo.git
          cd mihomo
          go build -o $GOPATH/bin/mihomo .
          cd ..
          $GOPATH/bin/mihomo version || true

      - name: Download ZKEEN dat files
        run: |
          mkdir -p tmp
          wget -q https://github.com/jameszeroX/zkeen-ip/releases/latest/download/zkeenip.dat -O tmp/zkeenip.dat
          wget -q https://github.com/jameszeroX/zkeen-domains/releases/latest/download/zkeen.dat -O tmp/zkeen.dat
          ls -l tmp

      - name: Unpack GeoIP (v2dat)
        run: |
          mkdir -p tmp/geoip
          v2dat unpack geoip -d tmp/geoip tmp/zkeenip.dat
          ls -l tmp/geoip | head -n 100

      - name: Unpack GeoSite (v2dat)
        run: |
          mkdir -p tmp/geosite
          v2dat unpack geosite -d tmp/geosite tmp/zkeen.dat
          ls -l tmp/geosite | head -n 100

      - name: Convert TXT → MRS (mihomo)
        run: |
          mkdir -p rules/geoip rules/geosite

          for f in tmp/geoip/*.txt; do
            base=$(basename "$f" .txt)
            echo "Converting geoip: $base"
            mihomo convert-ruleset ipcidr text "$f" "rules/geoip/$base.mrs" \
              || cp "$f" "rules/geoip/$base.txt"
          done

          for f in tmp/geosite/*.txt; do
            base=$(basename "$f" .txt)
            echo "Converting geosite: $base"
            mihomo convert-ruleset domain text "$f" "rules/geosite/$base.mrs" \
              || cp "$f" "rules/geosite/$base.txt"
          done

      - name: Commit & Push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add rules || true
          git commit -m "Auto update MRS (v2dat manual build)" || true
          git push || true
