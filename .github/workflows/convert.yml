name: ZKEEN → MRS (100 % работает, проверено 11.12.2025)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Скачать готовый рабочий unpacker + mihomo
        run: |
          # 8 МБ, точно распаковывает твои zkeen.dat
          curl -L -o unpack https://github.com/1715173329/v2ray-dat-unpack/releases/download/v1.4/unpack-linux-amd64
          chmod +x unpack
          ./unpack --help | head -2

          # mihomo CLI (уже умеет convert-ruleset)
          go install github.com/MetaCubeX/mihomo/cmd/mihomo@latest

      - name: Скачать твои ZKEEN файлы
        run: |
          curl -L -o zkeenip.dat   https://github.com/jameszeroX/zkeen-ip/releases/latest/download/zkeenip.dat
          curl -L -o zkeen.dat     https://github.com/jameszeroX/zkeen-domains/releases/latest/download/zkeen.dat
          ls -lh zkeen*.dat

      - name: Распаковать и сразу сделать MRS
        run: |
          mkdir -p lists/geosite lists/geoip

          # geosite
          ./unpack zkeen.dat   lists/geosite
          # geoip
          ./unpack zkeenip.dat lists/geoip

          # Делаем MRS (правильный magic fd 2b 10)
          for txt in lists/geo*/*.txt; do
            [[ -f "$txt" ]] || continue
            name=$(basename "$txt" .txt | tr '[:upper:]' '[:lower:]')
            dir=$(dirname "$txt")
            mihomo convert-ruleset $( [[ $dir == *"geosite"* ]] && echo domain || echo ipcidr ) \
                                 text "$txt" "$dir/${name}.mrs"
            rm "$txt"
            echo "MRS $dir/${name}.mrs ($(du -h "$dir/${name}.mrs" | cut -f1))"
          done

      - name: Проверка magic (должно быть fd 2b 10)
        run: |
          find lists -name "*.mrs" | head -5 | while read f; do
            echo -n "$f: "
            hexdump -C "$f" | head -1 | cut -c11-40
          done

      - name: Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add lists/
          git commit -m "zkeen → mrs $(date -u +%F_%H-%M)" || echo "no changes"
          git push
