name: ZKEEN dat → MRS (v2dat build + mihomo)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GOPATH: ${{ github.workspace }}/.gopath
      GOBIN: ${{ github.workspace }}/.gopath/bin
      PATH: ${{ github.workspace }}/.gopath/bin:/usr/local/go/bin:${PATH}

    steps:
      - name: Checkout repo (for push)
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.20"

      - name: Create GOPATH bin
        run: |
          mkdir -p "${GOPATH}/bin"

      - name: Build v2dat from urlesistiana source
        run: |
          set -euo pipefail
          # clone only once, keep shallow
          if [ ! -d v2dat-src ]; then
            git clone --depth 1 https://github.com/urlesistiana/v2dat.git v2dat-src
          fi
          cd v2dat-src/cmd/v2dat
          go build -o "${GOBIN}/v2dat" .
          "${GOBIN}/v2dat" --help | head -n 5

      - name: Install mihomo (go install)
        run: |
          set -euo pipefail
          # install mihomo binary to GOBIN
          go install github.com/metacubex/mihomo@latest
          # ensure installed
          ls -l "${GOBIN}" || true
          if command -v mihomo >/dev/null 2>&1; then echo "mihomo in PATH"; else echo "mihomo not in PATH yet"; fi
          mihomo version || true

      - name: Download ZKEEN dat files (try releases, fallback to raw/main)
        run: |
          set -euo pipefail
          mkdir -p tmp
          GEOIP_RELEASE="https://github.com/jameszeroX/zkeen-ip/releases/latest/download/zkeenip.dat"
          GEOIP_RAW="https://raw.githubusercontent.com/jameszeroX/zkeen-ip/main/zkeenip.dat"
          GEOSITE_RELEASE="https://github.com/jameszeroX/zkeen-domains/releases/latest/download/zkeen.dat"
          GEOSITE_RAW="https://raw.githubusercontent.com/jameszeroX/zkeen-domains/main/zkeen.dat"

          echo "Downloading geoip: try release URL first..."
          if ! curl -fsS --retry 3 --retry-delay 3 -o tmp/zkeenip.dat "$GEOIP_RELEASE"; then
            echo "release not available, trying raw/main..."
            curl -fsS --retry 3 --retry-delay 3 -o tmp/zkeenip.dat "$GEOIP_RAW"
          fi

          echo "Downloading geosite: try release URL first..."
          if ! curl -fsS --retry 3 --retry-delay 3 -o tmp/zkeen.dat "$GEOSITE_RELEASE"; then
            echo "release not available, trying raw/main..."
            curl -fsS --retry 3 --retry-delay 3 -o tmp/zkeen.dat "$GEOSITE_RAW"
          fi

          ls -lh tmp
          file tmp/zkeenip.dat || true
          file tmp/zkeen.dat || true

      - name: Validate DAT files
        run: |
          set -euo pipefail
          for f in tmp/*.dat; do
            echo "Checking $f"
            if [ ! -s "$f" ]; then
              echo "ERROR: $f is empty" >&2; exit 1
            fi
            # quick check to avoid HTML error pages
            if head -c 256 "$f" | grep -iq "<html\|<!DOCTYPE"; then
              echo "ERROR: $f appears to contain HTML (download failed)" >&2; exit 1
            fi
          done

      - name: Unpack GeoIP dat → TXT (v2dat)
        run: |
          set -euo pipefail
          mkdir -p tmp/geoip
          "${GOBIN}/v2dat" unpack -d tmp/geoip tmp/zkeenip.dat
          echo "GeoIP files:"
          ls -lh tmp/geoip | sed -n '1,200p'

      - name: Unpack GeoSite dat → TXT (v2dat)
        run: |
          set -euo pipefail
          mkdir -p tmp/geosite
          "${GOBIN}/v2dat" unpack -d tmp/geosite tmp/zkeen.dat
          echo "GeoSite files:"
          ls -lh tmp/geosite | sed -n '1,200p'

      - name: Convert TXT → MRS (geoip)
        run: |
          set -euo pipefail
          mkdir -p rules/geoip
          shopt -s nullglob || true
          for f in tmp/geoip/*.txt; do
            name=$(basename "$f" .txt)
            echo "Converting geoip: $name"
            if mihomo convert-ruleset ipcidr text "$f" "rules/geoip/$name.mrs"; then
              echo "Converted rules/geoip/$name.mrs"
            else
              echo "mihomo conversion failed for $f — saving raw txt as fallback"
              cp -f "$f" "rules/geoip/$name.txt"
            fi
          done

      - name: Convert TXT → MRS (geosite)
        run: |
          set -euo pipefail
          mkdir -p rules/geosite
          shopt -s nullglob || true
          for f in tmp/geosite/*.txt; do
            name=$(basename "$f" .txt)
            echo "Converting geosite: $name"
            if mihomo convert-ruleset domain text "$f" "rules/geosite/$name.mrs"; then
              echo "Converted rules/geosite/$name.mrs"
            else
              echo "mihomo conversion failed for $f — saving raw txt as fallback"
              cp -f "$f" "rules/geosite/$name.txt"
            fi
          done

      - name: Commit & Push generated rules
        run: |
          set -euo pipefail
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add rules || true
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-update ZKEEN -> MRS" || true
            git push || echo "Push failed (check permissions)"
          fi
