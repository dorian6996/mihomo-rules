name: ZKEEN dat → mihomo rules (geofileviewer logic)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"

      - name: Prepare directories
        run: |
          mkdir -p tmp rules/geosite rules/geoip

      - name: Install tools
        run: |
          go install github.com/urlesistiana/v2dat@latest
          go install github.com/metacubex/mihomo@latest

      - name: Download dat files
        run: |
          curl -fsSL -o tmp/geosite.dat \
            https://github.com/jameszeroX/zkeen-domains/releases/latest/download/zkeen.dat
          curl -fsSL -o tmp/geoip.dat \
            https://github.com/jameszeroX/zkeen-ip/releases/latest/download/zkeenip.dat

      # =========================
      # GEOIP (как раньше, но без geoip_ в имени)
      # =========================
      - name: Build geoip rules
        run: |
          mkdir -p tmp/geoip
          v2dat unpack geoip -o tmp/geoip tmp/geoip.dat

          rm -rf rules/geoip/*
          for f in tmp/geoip/*.txt; do
            name=$(basename "$f" .txt | sed 's/^geoip_//')
            grep -v '^#' "$f" | grep -v '^$' > "rules/geoip/$name.txt"

            echo "payload:" > "rules/geoip/$name.yaml"
            sed 's/^/  - /' "rules/geoip/$name.txt" >> "rules/geoip/$name.yaml"

            mihomo convert-ruleset ipcidr text \
              "rules/geoip/$name.txt" \
              "rules/geoip/$name.mrs" || true
          done

      # =========================
      # GEOSITE (через geofileviewer)
      # =========================
      - name: Clone geofileviewer
        run: |
          git clone --depth=1 https://github.com/jomertix/geofileviewer.git gv

      - name: Install geofileviewer deps
        run: |
          cd gv
          npm install

      - name: Export geosite via geofileviewer
        run: |
          cd gv
          node << 'EOF'
          const fs = require('fs');
          const { parseGeoSite } = require('./src/geosite');

          const data = fs.readFileSync('../tmp/geosite.dat');
          const result = parseGeoSite(data);

          fs.writeFileSync('../tmp/geosite.json', JSON.stringify(result, null, 2));
          EOF

      - name: Build geosite rules (mihomo format)
        run: |
          rm -rf rules/geosite/*
          node << 'EOF'
          const fs = require('fs');

          const data = JSON.parse(fs.readFileSync('tmp/geosite.json', 'utf8'));

          for (const [name, domains] of Object.entries(data)) {
            const yamlPath = `rules/geosite/${name}.yaml`;
            const txtPath  = `rules/geosite/${name}.txt`;

            fs.writeFileSync(yamlPath, 'payload:\n');
            fs.writeFileSync(txtPath, '');

            for (const d of domains) {
              fs.appendFileSync(yamlPath, `  - +.${d}\n`);
              fs.appendFileSync(txtPath, `${d}\n`);
            }
          }
          EOF

          for f in rules/geosite/*.txt; do
            name=$(basename "$f" .txt)
            mihomo convert-ruleset domain text \
              "$f" \
              "rules/geosite/$name.mrs" || true
          done

      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add rules/
          if git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "chore: rebuild rules using geofileviewer logic"
            git push
          fi
