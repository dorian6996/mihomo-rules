name: ZKEEN dat → mihomo YAML (protobuf-correct)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"

      - name: Prepare directories
        run: |
          mkdir -p tmp rules/geosite rules/geoip proto

      - name: Install tools
        run: |
          pip install protobuf grpcio-tools
          go install github.com/urlesistiana/v2dat@latest
          go install github.com/metacubex/mihomo@latest

      - name: Download dat files
        run: |
          curl -fsSL -o tmp/geosite.dat \
            https://github.com/jameszeroX/zkeen-domains/releases/latest/download/zkeen.dat
          curl -fsSL -o tmp/geoip.dat \
            https://github.com/jameszeroX/zkeen-ip/releases/latest/download/zkeenip.dat

      # =========================
      # GEOIP (как раньше, v2dat)
      # =========================
      - name: Build geoip
        run: |
          mkdir -p tmp/geoip
          v2dat unpack geoip -o tmp/geoip tmp/geoip.dat

          rm -rf rules/geoip/*
          for f in tmp/geoip/*.txt; do
            name=$(basename "$f" .txt)
            grep -v '^#' "$f" | grep -v '^$' > "rules/geoip/$name.txt"
            echo "payload:" > "rules/geoip/$name.yaml"
            while read -r line; do
              echo "  - $line" >> "rules/geoip/$name.yaml"
            done < "rules/geoip/$name.txt"
            mihomo convert-ruleset ipcidr text \
              "rules/geoip/$name.txt" \
              "rules/geoip/$name.mrs" || true
          done

      # =========================
      # GEOSITE (protobuf, как viewer)
      # =========================
      - name: Prepare proto files
        run: |
          curl -fsSL -o proto/geosite.proto \
            https://raw.githubusercontent.com/v2fly/v2ray-core/master/app/router/config.proto

      - name: Compile proto
        run: |
          python -m grpc_tools.protoc \
            -I proto \
            --python_out=. \
            proto/geosite.proto

      - name: Build geosite (protobuf correct)
        run: |
          cat > parse_geosite.py << 'EOF'
          from collections import defaultdict
          import os
          from app.router import config_pb2

          data = open("tmp/geosite.dat", "rb").read()
          geo = config_pb2.GeoSiteList()
          geo.ParseFromString(data)

          os.makedirs("rules/geosite", exist_ok=True)

          for site in geo.entry:
              name = site.country_code.lower()
              domains = set()

              for d in site.domain:
                  domains.add(d.value)

              with open(f"rules/geosite/{name}.yaml", "w") as f:
                  f.write("payload:\n")
                  for dom in sorted(domains):
                      f.write(f"  - +.{dom}\n")
          EOF

          python3 parse_geosite.py

          # build mrs
          for f in rules/geosite/*.yaml; do
            name=$(basename "$f" .yaml)
            sed 's/^  - +\.//' "$f" > "rules/geosite/$name.txt"
            mihomo convert-ruleset domain text \
              "rules/geosite/$name.txt" \
              "rules/geosite/$name.mrs" || true
            rm -f "rules/geosite/$name.txt"
          done

      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add rules/
          git diff --staged --quiet || git commit -m "chore: rebuild rules via protobuf geosite"
          git push
