name: Convert ZKEEN dat → MRS

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"  # каждые 6 часов

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install v2dat
        run: |
          V2DAT_VER=$(curl -s https://api.github.com/repos/urlesistiana/v2dat/releases/latest | grep tag_name | cut -d '"' -f 4)
          wget -q https://github.com/urlesistiana/v2dat/releases/download/${V2DAT_VER}/v2dat-linux-64.zip
          unzip v2dat-linux-64.zip v2dat
          chmod +x v2dat
          sudo mv v2dat /usr/local/bin/v2dat

      - name: Install Mihomo
        run: |
          VER=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | grep tag_name | cut -d '"' -f 4)
          wget -q https://github.com/MetaCubeX/mihomo/releases/download/${VER}/mihomo-linux-amd64-${VER}.deb
          sudo dpkg -i mihomo-linux-amd64-${VER}.deb

      - name: Download ZKEEN dat files
        run: |
          mkdir -p tmp
          wget -q https://github.com/jameszeroX/zkeen-ip/releases/latest/download/zkeenip.dat -O tmp/zkeenip.dat
          wget -q https://github.com/jameszeroX/zkeen-domains/releases/latest/download/zkeen.dat -O tmp/zkeen.dat

      - name: Extract GeoIP → TXT
        run: |
          mkdir -p tmp/geoip
          v2dat geoip --dump tmp/zkeenip.dat --dir tmp/geoip

      - name: Extract GeoSite → TXT
        run: |
          mkdir -p tmp/geosite
          v2dat geosite --dump tmp/zkeen.dat --dir tmp/geosite

      - name: Convert GeoIP → MRS
        run: |
          mkdir -p rules/geoip
          for f in tmp/geoip/*.txt; do
            name=$(basename "$f" .txt)
            echo "Converting GeoIP $name"
            mihomo convert-ruleset ipcidr text "$f" "rules/geoip/$name.mrs"
          done

      - name: Convert GeoSite → MRS
        run: |
          mkdir -p rules/geosite
          for f in tmp/geosite/*.txt; do
            name=$(basename "$f" .txt)
            echo "Converting GeoSite $name"
            mihomo convert-ruleset domain text "$f" "rules/geosite/$name.mrs"
          done

      - name: Commit MRS files
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add rules
          git commit -m "Auto-update ZKEEN → MRS" || echo "No changes"
          git push
