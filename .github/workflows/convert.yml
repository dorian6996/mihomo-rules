name: ZKEEN dat → mihomo rules (geofileviewer logic, final)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"

      - name: Prepare directories
        run: |
          mkdir -p tmp rules/geosite rules/geoip

      - name: Install tools
        run: |
          go install github.com/urlesistiana/v2dat@latest
          go install github.com/metacubex/mihomo@latest

      - name: Download dat files
        run: |
          curl -fsSL -o tmp/geosite.dat \
            https://github.com/jameszeroX/zkeen-domains/releases/latest/download/zkeen.dat
          curl -fsSL -o tmp/geoip.dat \
            https://github.com/jameszeroX/zkeen-ip/releases/latest/download/zkeenip.dat

      # =========================
      # GEOIP (как раньше, но без geoip_ в имени)
      # =========================
      - name: Build geoip rules
        run: |
          mkdir -p tmp/geoip
          v2dat unpack geoip -o tmp/geoip tmp/geoip.dat

          rm -rf rules/geoip/*
          for f in tmp/geoip/*.txt; do
            name=$(basename "$f" .txt | sed 's/^geoip_//')
            grep -v '^#' "$f" | grep -v '^$' > "rules/geoip/$name.txt"

            echo "payload:" > "rules/geoip/$name.yaml"
            sed 's/^/  - /' "rules/geoip/$name.txt" >> "rules/geoip/$name.yaml"

            mihomo convert-ruleset ipcidr text \
              "rules/geoip/$name.txt" \
              "rules/geoip/$name.mrs" || true
          done

      # =========================
      # GEOSITE (логика geofileviewer)
      # =========================
      - name: Parse geosite.dat (geofileviewer logic)
        run: |
          node << 'EOF'
          const fs = require('fs');
          const path = require('path');

          // ---- helpers from geofileviewer logic ----
          function readVarint(buf, offset) {
            let result = 0;
            let shift = 0;
            let pos = offset;
            while (true) {
              const b = buf[pos++];
              result |= (b & 0x7f) << shift;
              if ((b & 0x80) === 0) break;
              shift += 7;
            }
            return [result, pos];
          }

          function parseGeoSite(buffer) {
            let pos = 0;
            const groups = {};

            while (pos < buffer.length) {
              let size;
              try {
                [size, pos] = readVarint(buffer, pos);
              } catch {
                break;
              }
              const block = buffer.slice(pos, pos + size);
              pos += size;

              let name = null;
              const domains = [];

              let i = 0;
              while (i < block.length) {
                const tag = block[i++];
                const field = tag >> 3;
                const wire = tag & 7;

                if (wire === 2) {
                  let len;
                  [len, i] = readVarint(block, i);
                  const value = block.slice(i, i + len);
                  i += len;

                  if (field === 1) {
                    name = value.toString('utf8').toLowerCase();
                  } else if (field === 2) {
                    domains.push(value.toString('utf8'));
                  }
                } else {
                  i++;
                }
              }

              if (name && domains.length) {
                groups[name] = Array.from(new Set(domains));
              }
            }
            return groups;
          }

          const data = fs.readFileSync('tmp/geosite.dat');
          const groups = parseGeoSite(data);

          fs.mkdirSync('rules/geosite', { recursive: true });

          for (const [name, domains] of Object.entries(groups)) {
            const txt = [];
            const yaml = ['payload:'];

            for (const d of domains.sort()) {
              txt.push(d);
              yaml.push(`  - +.${d}`);
            }

            fs.writeFileSync(`rules/geosite/${name}.txt`, txt.join('\n') + '\n');
            fs.writeFileSync(`rules/geosite/${name}.yaml`, yaml.join('\n') + '\n');
          }
          EOF

      - name: Build geosite MRS
        run: |
          for f in rules/geosite/*.txt; do
            name=$(basename "$f" .txt)
            mihomo convert-ruleset domain text \
              "$f" \
              "rules/geosite/$name.mrs" || true
          done

      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add rules/
          if git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "chore: rebuild geo rules (geofileviewer logic)"
            git push
          fi
