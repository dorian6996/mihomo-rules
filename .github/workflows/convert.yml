name: ZKEEN dat â†’ mihomo YAML (viewer logic, fixed)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"

      - name: Prepare directories
        run: |
          mkdir -p tmp rules/geosite rules/geoip

      - name: Install tools
        run: |
          pip install protobuf
          go install github.com/urlesistiana/v2dat@latest
          go install github.com/metacubex/mihomo@latest

      - name: Download dat files
        run: |
          curl -fsSL -o tmp/geosite.dat \
            https://github.com/jameszeroX/zkeen-domains/releases/latest/download/zkeen.dat
          curl -fsSL -o tmp/geoip.dat \
            https://github.com/jameszeroX/zkeen-ip/releases/latest/download/zkeenip.dat

      # =========================
      # GEOIP (v2dat, FIXED)
      # =========================
      - name: Build geoip
        run: |
          mkdir -p tmp/geoip
          v2dat unpack geoip -o tmp/geoip tmp/geoip.dat

          rm -rf rules/geoip/*
          for f in tmp/geoip/*.txt; do
            name=$(basename "$f" .txt)
            grep -v '^#' "$f" | grep -v '^$' > "rules/geoip/$name.txt"

            echo "payload:" > "rules/geoip/$name.yaml"
            while read -r line; do
              echo "  - $line" >> "rules/geoip/$name.yaml"
            done < "rules/geoip/$name.txt"

            mihomo convert-ruleset ipcidr text \
              "rules/geoip/$name.txt" \
              "rules/geoip/$name.mrs" || true
          done

      # =========================
      # GEOSITE (viewer logic)
      # =========================
      - name: Build geosite (protobuf, +.)
        run: |
          cat > parse_geosite.py << 'EOF'
          import os
          from collections import defaultdict
          from google.protobuf.internal.decoder import _DecodeVarint32

          def read_varint(buf, pos):
              result, shift = 0, 0
              while True:
                  b = buf[pos]
                  pos += 1
                  result |= (b & 0x7f) << shift
                  if not (b & 0x80):
                      return result, pos
                  shift += 7

          def parse_geosite(path):
              with open(path, "rb") as f:
                  data = f.read()

              pos = 0
              out = defaultdict(set)

              while pos < len(data):
                  try:
                      size, pos = _DecodeVarint32(data, pos)
                  except Exception:
                      break

                  block = data[pos:pos + size]
                  pos += size

                  name = None
                  domains = []

                  i = 0
                  while i < len(block):
                      tag = block[i]
                      i += 1
                      field = tag >> 3
                      wire = tag & 7

                      if wire == 2:
                          l, i = read_varint(block, i)
                          val = block[i:i + l]
                          i += l

                          if field == 1:
                              name = val.decode()
                          elif field == 2:
                              domains.append(val.decode())
                      else:
                          i += 1

                  if name:
                      for d in domains:
                          out[name].add(d)

              return out

          geosites = parse_geosite("tmp/geosite.dat")
          os.makedirs("rules/geosite", exist_ok=True)

          for name, domains in geosites.items():
              with open(f"rules/geosite/{name}.yaml", "w") as f:
                  f.write("payload:\n")
                  for d in sorted(domains):
                      f.write(f"  - +.{d}\n")
          EOF

          python3 parse_geosite.py

          # MRS generation
          for f in rules/geosite/*.yaml; do
            name=$(basename "$f" .yaml)
            sed 's/^  - +\.//' "$f" > "rules/geosite/$name.txt"
            mihomo convert-ruleset domain text \
              "rules/geosite/$name.txt" \
              "rules/geosite/$name.mrs" || true
            rm -f "rules/geosite/$name.txt"
          done

      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add rules/
          if git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "chore: rebuild rules using geofileviewer logic"
            git push
          fi
