name: ZKEEN dat → MRS (via v2dat + mihomo)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"   # каждые 6 часов — поменяй если нужно

jobs:
  build-and-convert:
    runs-on: ubuntu-latest
    env:
      GOPATH: ${{ runner.home }}/go

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install system deps
        run: |
          sudo apt-get update -y
          sudo apt-get install -y build-essential wget unzip ca-certificates git

      - name: Install Go (1.20+)
        run: |
          if ! command -v go >/dev/null 2>&1; then
            wget -q https://go.dev/dl/go1.20.9.linux-amd64.tar.gz -O /tmp/go.tgz
            sudo rm -rf /usr/local/go
            sudo tar -C /usr/local -xzf /tmp/go.tgz
          fi
          export PATH=/usr/local/go/bin:$PATH
          go version

      - name: Install v2dat (build via go install)
        run: |
          export PATH=/usr/local/go/bin:${GOPATH}/bin:$PATH
          go install github.com/urlesistiana/v2dat@latest
          # sanity
          command -v v2dat
          v2dat --help | head -n 5

      - name: Install mihomo (build via go install)
        run: |
          export PATH=/usr/local/go/bin:${GOPATH}/bin:$PATH
          go install github.com/metacubex/mihomo@latest
          # sanity
          command -v mihomo || true
          mihomo version || true

      - name: Download ZKEEN dat files
        run: |
          mkdir -p tmp
          wget -q https://github.com/jameszeroX/zkeen-ip/releases/latest/download/zkeenip.dat -O tmp/zkeenip.dat
          wget -q https://github.com/jameszeroX/zkeen-domains/releases/latest/download/zkeen.dat -O tmp/zkeen.dat
          ls -l tmp

      - name: Unpack GeoIP dat → TXT (v2dat)
        run: |
          mkdir -p tmp/geoip
          # unpack all tags/categories
          v2dat unpack geoip -d tmp/geoip tmp/zkeenip.dat
          echo "Created geoip files:"
          ls -l tmp/geoip | sed -n '1,200p'

      - name: Unpack GeoSite dat → TXT (v2dat)
        run: |
          mkdir -p tmp/geosite
          v2dat unpack geosite -d tmp/geosite tmp/zkeen.dat
          echo "Created geosite files:"
          ls -l tmp/geosite | sed -n '1,200p'

      - name: Convert GeoIP TXT → MRS (mihomo)
        run: |
          mkdir -p rules/geoip
          export PATH=/usr/local/go/bin:${GOPATH}/bin:$PATH
          shopt -s nullglob || true
          for f in tmp/geoip/*.txt; do
            name=$(basename "$f" .txt)
            echo "Converting geoip category: $name"
            # convert ipcidr text -> mrs
            mihomo convert-ruleset ipcidr text "$f" "rules/geoip/$name.mrs" || {
              echo "FAILED to convert $f — saving as text fallback"
              cp -f "$f" "rules/geoip/$name.txt"
            }
          done

      - name: Convert GeoSite TXT → MRS (mihomo)
        run: |
          mkdir -p rules/geosite
          export PATH=/usr/local/go/bin:${GOPATH}/bin:$PATH
          shopt -s nullglob || true
          for f in tmp/geosite/*.txt; do
            name=$(basename "$f" .txt)
            echo "Converting geosite category: $name"
            # convert domain text -> mrs
            mihomo convert-ruleset domain text "$f" "rules/geosite/$name.mrs" || {
              echo "FAILED to convert $f — saving as text fallback"
              cp -f "$f" "rules/geosite/$name.txt"
            }
          done

      - name: Commit & push generated rules
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add rules || true
          git commit -m "Auto-update ZKEEN -> MRS (v2dat + mihomo)" || echo "No changes to commit"
          git push || echo "Push failed (probably no permission)"
