name: ZKEEN dat → MRS (tested & working)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Go 1.22
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install v2dat (unpacker) from source
        run: |
          git clone --depth 1 https://github.com/urlesistiana/v2dat.git
          cd v2dat/cmd/v2dat
          go build -ldflags="-s -w" -o $GITHUB_WORKSPACE/v2dat .
          echo "$GITHUB_WORKSPACE" >> $GITHUB_PATH
          v2dat --help | head -n 3

      - name: Install mihomo CLI (for convert-ruleset)
        run: |
          go install github.com/MetaCubeX/mihomo/cmd/mihomo@latest
          mihomo version

      - name: Download ZKEEN .dat files
        run: |
          mkdir -p tmp
          curl -fsSL -o tmp/zkeenip.dat \
            https://github.com/jameszeroX/zkeen-ip/releases/latest/download/zkeenip.dat
          curl -fsSL -o tmp/zkeen.dat \
            https://github.com/jameszeroX/zkeen-domains/releases/latest/download/zkeen.dat
          ls -lh tmp

      - name: Unpack GeoIP.dat → txt
        run: |
          mkdir -p unpack/geoip
          v2dat unpack tmp/zkeenip.dat -o unpack/geoip
          ls -1 unpack/geoip | wc -l

      - name: Unpack GeoSite.dat → txt
        run: |
          mkdir -p unpack/geosite
          v2dat unpack tmp/zkeen.dat -o unpack/geosite
          ls -1 unpack/geosite | wc -l

      - name: Convert TXT → real MRS (mihomo format)
        run: |
          mkdir -p lists/geoip lists/geosite

          # GeoIP
          for txt in unpack/geoip/*.txt; do
            [[ -f "$txt" ]] || continue
            name=$(basename "$txt" .txt | tr '[:upper:]' '[:lower:]')
            mihomo convert-ruleset ipcidr text "$txt" "lists/geoip/${name}.mrs" && \
              echo "MRS geoip/${name}.mrs ($(du -h "lists/geoip/${name}.mrs" | cut -f1))"
          done

          # GeoSite
          for txt in unpack/geosite/*.txt; do
            [[ -f "$txt" ]] || continue
            name=$(basename "$txt" .txt | tr '[:upper:]' '[:lower:]')
            mihomo convert-ruleset domain text "$txt" "lists/geosite/${name}.mrs" && \
              echo "MRS geosite/${name}.mrs ($(du -h "lists/geosite/${name}.mrs" | cut -f1))"
          done

      - name: Verify MRS magic (debug)
        run: |
          echo "Sample MRS headers:"
          find lists -name "*.mrs" | head -5 | while read f; do
            echo -n "$f: "
            hexdump -C "$f" | head -1
          done

      - name: Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add lists/
          git commit -m "auto: zkeen dat → mrs $(date -u +%F_%H-%M)" || echo "No changes"
          git push
