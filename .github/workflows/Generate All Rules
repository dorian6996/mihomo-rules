name: Generate All Rules

on:
  schedule:
    - cron: "0 4 */3 * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
      
      - name: Create directories
        run: |
          mkdir -p temp lists/geosite lists/geoip
          
      - name: Download DAT files
        run: |
          echo "ðŸ“¥ Downloading zkeen.dat..."
          curl -fsSL --retry 5 --retry-delay 10 -o temp/zkeen.dat \
            https://github.com/jameszeroX/zkeen-domains/releases/latest/download/zkeen.dat
          
          echo "ðŸ“¥ Downloading zkeenip.dat..."
          curl -fsSL --retry 5 --retry-delay 10 -o temp/zkeenip.dat \
            https://github.com/jameszeroX/zkeen-ip/releases/latest/download/zkeenip.dat
          
          echo "âœ… Downloaded:"
          ls -lh temp/
      
      - name: Install Mihomo
        run: |
          echo "ðŸ“¦ Installing Mihomo..."
          curl -fsSL -o mihomo.gz \
            https://github.com/MetaCubeX/mihomo/releases/download/v1.18.10/mihomo-linux-amd64-v1.18.10.gz
          
          gunzip mihomo.gz
          chmod +x mihomo
          ./mihomo -v
      
      - name: Install sing-box for category extraction
        run: |
          echo "ðŸ“¦ Installing sing-box..."
          go install -v github.com/sagernet/sing-box/cmd/sing-box@latest
          echo "âœ… sing-box installed"
      
      - name: Extract all GeoSite categories
        run: |
          echo "ðŸ” Extracting GeoSite categories..."
          ~/go/bin/sing-box geosite list -f temp/zkeen.dat > temp/geosite_categories.txt
          
          echo "Found $(wc -l < temp/geosite_categories.txt) GeoSite categories"
          echo "First 20 categories:"
          head -20 temp/geosite_categories.txt
      
      - name: Extract all GeoIP categories
        run: |
          echo "ðŸ” Extracting GeoIP categories..."
          ~/go/bin/sing-box geoip list -f temp/zkeenip.dat > temp/geoip_categories.txt
          
          echo "Found $(wc -l < temp/geoip_categories.txt) GeoIP categories"
          echo "First 20 categories:"
          head -20 temp/geoip_categories.txt
      
      - name: Convert GeoSite to MRS
        run: |
          echo "ðŸ”„ Converting GeoSite to MRS..."
          
          count=0
          failed=0
          
          while IFS= read -r category; do
            if [ -n "$category" ] && [ "$category" != "test" ]; then
              if ./mihomo convert-ruleset domain mrs temp/zkeen.dat "lists/geosite/${category}.mrs" "$category" 2>/dev/null; then
                ((count++))
              else
                ((failed++))
              fi
            fi
          done < temp/geosite_categories.txt
          
          echo "âœ… Converted: $count MRS files"
          [ $failed -gt 0 ] && echo "âš ï¸  Failed: $failed"
      
      - name: Convert GeoSite to YAML
        run: |
          echo "ðŸ”„ Converting GeoSite to YAML..."
          
          count=0
          failed=0
          
          while IFS= read -r category; do
            if [ -n "$category" ] && [ "$category" != "test" ]; then
              # ÐšÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð² text Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚
              if ./mihomo convert-ruleset domain text temp/zkeen.dat "temp/${category}.txt" "$category" 2>/dev/null; then
                # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ YAML Ñ payload ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¾Ð¹
                {
                  echo "payload:"
                  # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¾Ñ‚ÑÑ‚ÑƒÐ¿Ñ‹ Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐ¸
                  sed 's/^/  - /' "temp/${category}.txt"
                } > "lists/geosite/${category}.yaml"
                rm "temp/${category}.txt"
                ((count++))
              else
                ((failed++))
              fi
            fi
          done < temp/geosite_categories.txt
          
          echo "âœ… Converted: $count YAML files"
          [ $failed -gt 0 ] && echo "âš ï¸  Failed: $failed"
      
      - name: Convert GeoIP to MRS
        run: |
          echo "ðŸ”„ Converting GeoIP to MRS..."
          
          count=0
          failed=0
          
          while IFS= read -r category; do
            if [ -n "$category" ] && [ "$category" != "test" ]; then
              if ./mihomo convert-ruleset ipcidr mrs temp/zkeenip.dat "lists/geoip/${category}.mrs" "$category" 2>/dev/null; then
                ((count++))
              else
                ((failed++))
              fi
            fi
          done < temp/geoip_categories.txt
          
          echo "âœ… Converted: $count MRS files"
          [ $failed -gt 0 ] && echo "âš ï¸  Failed: $failed"
      
      - name: Convert GeoIP to YAML
        run: |
          echo "ðŸ”„ Converting GeoIP to YAML..."
          
          count=0
          failed=0
          
          while IFS= read -r category; do
            if [ -n "$category" ] && [ "$category" != "test" ]; then
              # ÐšÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð² text Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚
              if ./mihomo convert-ruleset ipcidr text temp/zkeenip.dat "temp/${category}.txt" "$category" 2>/dev/null; then
                # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ YAML Ñ payload ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¾Ð¹
                {
                  echo "payload:"
                  # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¾Ñ‚ÑÑ‚ÑƒÐ¿Ñ‹ Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐ¸
                  sed 's/^/  - /' "temp/${category}.txt"
                } > "lists/geoip/${category}.yaml"
                rm "temp/${category}.txt"
                ((count++))
              else
                ((failed++))
              fi
            fi
          done < temp/geoip_categories.txt
          
          echo "âœ… Converted: $count YAML files"
          [ $failed -gt 0 ] && echo "âš ï¸  Failed: $failed"
      
      - name: Verify generated files
        run: |
          echo "ðŸ“Š Summary:"
          echo ""
          echo "GeoSite MRS: $(ls lists/geosite/*.mrs 2>/dev/null | wc -l) files"
          echo "GeoSite YAML: $(ls lists/geosite/*.yaml 2>/dev/null | wc -l) files"
          echo "GeoIP MRS: $(ls lists/geoip/*.mrs 2>/dev/null | wc -l) files"
          echo "GeoIP YAML: $(ls lists/geoip/*.yaml 2>/dev/null | wc -l) files"
          echo ""
          
          # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð¸Ð¼ÐµÑ€ YAML Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð°
          if [ -f lists/geosite/openai.yaml ]; then
            echo "=== Sample YAML format (openai.yaml) ==="
            head -15 lists/geosite/openai.yaml
            echo ""
          fi
          
          # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ñ€Ð°Ð·Ð¼ÐµÑ€Ñ‹ Ñ‚Ð¾Ð¿ Ñ„Ð°Ð¹Ð»Ð¾Ð²
          echo "=== Top 10 largest files ==="
          find lists -name "*.mrs" -o -name "*.yaml" | xargs ls -lhS | head -10
      
      - name: Create README files
        run: |
          # README for geosite
          cat > lists/geosite/README.md << 'EOF'
# GeoSite Rules

Domain-based routing rules for Mihomo.

## Usage Examples

### MRS Format (Binary - Recommended)

```yaml
rule-providers:
  openai:
    type: http
    behavior: domain
    format: mrs
    interval: 86400
    url: https://raw.githubusercontent.com/dorian6996/mihomo-rules/main/lists/geosite/openai.mrs
    path: ./rules/openai.mrs

rules:
  - RULE-SET,openai,PROXY
```

### YAML Format (Text)

```yaml
rule-providers:
  openai:
    type: http
    behavior: domain
    format: yaml
    interval: 86400
    url: https://raw.githubusercontent.com/dorian6996/mihomo-rules/main/lists/geosite/openai.yaml
    path: ./rules/openai.yaml

rules:
  - RULE-SET,openai,PROXY
```

## Available Categories

EOF
          
          echo "### Domain Rules" >> lists/geosite/README.md
          echo "" >> lists/geosite/README.md
          
          for file in lists/geosite/*.mrs; do
            [ -e "$file" ] || continue
            name=$(basename "$file" .mrs)
            size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null || echo "?")
            echo "- \`${name}\` - ${size} bytes" >> lists/geosite/README.md
          done
          
          # README for geoip
          cat > lists/geoip/README.md << 'EOF'
# GeoIP Rules

IP-based routing rules for Mihomo.

## Usage Examples

### MRS Format (Binary - Recommended)

```yaml
rule-providers:
  telegram:
    type: http
    behavior: ipcidr
    format: mrs
    interval: 86400
    url: https://raw.githubusercontent.com/dorian6996/mihomo-rules/main/lists/geoip/telegram.mrs
    path: ./rules/telegram.mrs

rules:
  - RULE-SET,telegram,PROXY
```

### YAML Format (Text)

```yaml
rule-providers:
  telegram:
    type: http
    behavior: ipcidr
    format: yaml
    interval: 86400
    url: https://raw.githubusercontent.com/dorian6996/mihomo-rules/main/lists/geoip/telegram.yaml
    path: ./rules/telegram.yaml

rules:
  - RULE-SET,telegram,PROXY
```

## Available Categories

EOF
          
          echo "### IP Rules" >> lists/geoip/README.md
          echo "" >> lists/geoip/README.md
          
          for file in lists/geoip/*.mrs; do
            [ -e "$file" ] || continue
            name=$(basename "$file" .mrs)
            size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null || echo "?")
            echo "- \`${name}\` - ${size} bytes" >> lists/geoip/README.md
          done
      
      - name: Cleanup
        run: |
          rm -rf temp mihomo mihomo.gz
          rm -rf ~/go/bin/sing-box
      
      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git add lists/
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸  No changes to commit"
          else
            geosite_mrs=$(ls lists/geosite/*.mrs 2>/dev/null | wc -l)
            geosite_yaml=$(ls lists/geosite/*.yaml 2>/dev/null | wc -l)
            geoip_mrs=$(ls lists/geoip/*.mrs 2>/dev/null | wc -l)
            geoip_yaml=$(ls lists/geoip/*.yaml 2>/dev/null | wc -l)
            
            git commit -m "ðŸ¤– Auto-update rules

- GeoSite: ${geosite_mrs} MRS, ${geosite_yaml} YAML
- GeoIP: ${geoip_mrs} MRS, ${geoip_yaml} YAML

Generated at $(date -u +'%Y-%m-%d %H:%M UTC')"
            
            git push origin main
            echo "âœ… Changes pushed to main branch"
          fi
