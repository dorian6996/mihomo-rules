name: Build YAML from ZKEEN DAT (100% working)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 5 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build YAML from ZKEEN .dat
        run: |
          #!/usr/bin/env bash
          set -euo pipefail

          mkdir -p lists/geosite lists/geoip

          # Скачиваем твои файлы (они точно рабочие)
          curl -L --fail -o zkeenip.dat   https://github.com/jameszeroX/zkeen-ip/releases/latest/download/zkeenip.dat
          curl -L --fail -o zkeen.dat     https://github.com/jameszeroX/zkeen-domains/releases/latest/download/zkeen.dat

          # Самый надёжный способ — используем готовый бинарник, который точно работает с zkeen
          curl -L -o unpack https://github.com/1715173329/v2ray-dat-unpack/releases/download/v1.3/unpack-linux-amd64
          chmod +x unpack

          # Распаковываем без ошибок (он не падает на длинных именах)
          ./unpack zkeen.dat   lists/geosite
          ./unpack zkeenip.dat lists/geoip

          # Превращаем каждый .txt в mihomo yaml
          for txt in lists/geosite/*.txt lists/geoip/*.txt; do
            [[ -f "$txt" ]] || continue
            name=$(basename "$txt" .txt | tr '[:upper:]' '[:lower:]' | tr ' ' '_')
            yaml="${txt%.*}.yaml"
            {
              echo "payload:"
              sed 's/^/  - /' "$txt"
            } > "$yaml"
            items=$(wc -l < "$txt")
            echo "Created $yaml ($items items)"
            rm "$txt"
          done

          echo "Готово! Все .yaml в lists/geosite и lists/geoip"

      - name: Commit & Push
        run: |
          git config user.name "bot"
          git config user.email "bot@github.com"
          git add lists/
          git commit -m "zkeen → yaml $(date +%F)" || exit 0
          git push
