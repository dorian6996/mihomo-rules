name: Build mihomo yaml rules

on: [push, workflow_dispatch, schedule]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Convert .dat → .yaml directly
        run: |
          mkdir -p lists/geosite lists/geoip

          # Скачиваем актуальные .dat
          curl -L -L -o zkeenip.dat   https://github.com/jameszeroX/zkeen-ip/releases/latest/download/zkeenip.dat
          curl -L -o zkeen.dat       https://github.com/jameszeroX/zkeen-domains/releases/latest/download/zkeen.dat

          # Прямое преобразование dat → yaml (одна команда на файл)
          docker run --rm -v $(pwd):/work ghcr.io/metacubex/geoconvert:latest \
            geoip   -i zkeenip.dat   -o lists/geoip   --mihomo
          docker run --rm -v $(pwd):/work ghcr.io/metacubex/geoconvert:latest \
            geosite -i zkeen.dat     -o lists/geosite --mihomo

      - name: Commit & Push
        run: |
          git config --global user.name "bot"
          git add lists/
          git commit -m "update yaml $(date +%F)" || exit 0
          git push
