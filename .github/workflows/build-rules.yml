name: Build YAML Rulesets from ZKEEN DAT (with checks)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 4 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install geodat2srs
        run: go install github.com/runetfreedom/geodat2srs@latest

      - name: Download and check ZKEEN DAT, build YAML
        run: |
          #!/usr/bin/env bash
          set -euo pipefail

          ROOT="$(pwd)"
          TMPDIR="${ROOT}/tmp_dat"
          OUTDIR="${ROOT}/lists"
          GEOSITE_OUTDIR="${OUTDIR}/geosite"
          GEOIP_OUTDIR="${OUTDIR}/geoip"

          mkdir -p "$TMPDIR" "$GEOSITE_OUTDIR" "$GEOIP_OUTDIR"

          # Функция для скачивания с retry
          download_with_retry() {
            local url="$1"
            local output="$2"
            local max_attempts=3
            local attempt=1
            while [ $attempt -le $max_attempts ]; do
              echo "Downloading $output (attempt $attempt/$max_attempts)..."
              if curl -L --fail --connect-timeout 30 --max-time 300 --retry 3 --retry-delay 5 -o "$output" "$url"; then
                size=$(wc -c < "$output")
                if [ "$size" -eq 0 ]; then
                  echo "ERROR: $output is empty (0 bytes) — download failed"
                  rm -f "$output"
                  return 1
                fi
                echo "OK: $output downloaded ($size bytes)"
                return 0
              else
                echo "Failed attempt $attempt — waiting 10s..."
                sleep 10
              fi
              attempt=$((attempt + 1))
            done
            echo "ERROR: Failed to download $output after $max_attempts attempts"
            return 1
          }

          # [1] Скачиваем твои ZKEEN .dat с проверкой
          echo "[1] Downloading ZKEEN .dat files with retry and size check..."
          download_with_retry "https://github.com/jameszeroX/zkeen-ip/releases/latest/download/zkeenip.dat" "${TMPDIR}/zkeenip.dat" || exit 1
          download_with_retry "https://github.com/jameszeroX/zkeen-domains/releases/latest/download/zkeen.dat" "${TMPDIR}/zkeen.dat" || exit 1

          # [2] Конвертируем в текст
          echo "[2] Converting .dat to text lists..."
          "${HOME}/go/bin/geodat2srs" geoip -i "${TMPDIR}/zkeenip.dat" -o "${TMPDIR}" --prefix "zkeen-ip-"
          "${HOME}/go/bin/geodat2srs" geosite -i "${TMPDIR}/zkeen.dat" -o "${TMPDIR}" --prefix "zkeen-site-"

          # Проверяем, создались ли категории (лог первых 5 строк одной из них)
          echo "[2.5] Checking extracted categories (sample)..."
          if [ -d "${TMPDIR}/zkeen-site-youtube" ] || [ -f "${TMPDIR}/zkeen-site-youtube" ]; then
            echo "Sample youtube category (first 5 lines):"
            head -5 "${TMPDIR}/zkeen-site-youtube"/* 2>/dev/null | head -5 || echo "No content in youtube"
          else
            echo "No youtube category found — check if .dat has it"
          fi

          echo "[3] Generating clean .yaml files for mihomo..."

          # Функция для создания YAML
          create_yaml() {
            local text_file="$1"
            local yaml_file="$2"
            if [ ! -s "$text_file" ]; then
              echo "Skipped empty $yaml_file"
              return 0
            fi
            echo "payload:" > "$yaml_file"
            sed 's/^/  - /' "$text_file" >> "$yaml_file"
            lines=$(tail -n +2 "$yaml_file" | wc -l)  # lines без заголовка
            echo "  Generated $yaml_file ($lines items)"
          }

          # === Geosite (domain) ===
          count_generated=0
          for entry in "${TMPDIR}"/zkeen-site-*; do
            [[ -e "$entry" ]] || continue
            category="${entry##*/zkeen-site-}"
            category="${category%%.*}"
            category="${category// /_}"
            category="${category,,}"

            text_file="${GEOSITE_OUTDIR}/${category}.txt"
            yaml_file="${GEOSITE_OUTDIR}/${category}.yaml"

            if [[ -d "$entry" ]]; then
              find "$entry" -type f -print0 2>/dev/null | xargs -0 cat 2>/dev/null | grep -v '^$' | sort -u > "$text_file"
            else
              grep -v '^$' "$entry" 2>/dev/null | sort -u > "$text_file"
            fi

            create_yaml "$text_file" "$yaml_file"
            rm -f "$text_file"
            ((count_generated++))
          done

          # === GeoIP (ipcidr) ===
          for entry in "${TMPDIR}"/zkeen-ip-*; do
            [[ -e "$entry" ]] || continue
            category="${entry##*/zkeen-ip-}"
            category="${category%%.*}"
            category="${category// /_}"
            category="${category,,}"

            text_file="${GEOIP_OUTDIR}/${category}.txt"
            yaml_file="${GEOIP_OUTDIR}/${category}.yaml"

            if [[ -d "$entry" ]]; then
              find "$entry" -type f -print0 2>/dev/null | xargs -0 cat 2>/dev/null | grep -v '^$' | sort -u > "$text_file"
            else
              grep -v '^$' "$entry" 2>/dev/null | sort -u > "$text_file"
            fi

            create_yaml "$text_file" "$yaml_file"
            rm -f "$text_file"
            ((count_generated++))
          done

          # Cleanup
          rm -rf "$TMPDIR"
          echo "Done! Generated $count_generated YAML files in lists/geosite/ and lists/geoip/"

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add lists/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "auto: update yaml rules from zkeen dat $(date -u +%Y-%m-%d)"
            git push
          fi
