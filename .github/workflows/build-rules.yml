name: Build MRS rulesets

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 3 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y zstd
          go install github.com/runetfreedom/geodat2srs@latest

      - name: Build MRS files
        run: |
          #!/usr/bin/env bash
          set -euo pipefail

          ROOT="$(pwd)"
          TMPDIR="${ROOT}/tmp_dat"
          OUTDIR="${ROOT}/lists"
          GEOSITE_OUTDIR="${OUTDIR}/geosite"
          GEOIP_OUTDIR="${OUTDIR}/geoip"

          mkdir -p "$TMPDIR" "$GEOSITE_OUTDIR" "$GEOIP_OUTDIR"

          GEOIP_URL="https://github.com/jameszeroX/zkeen-ip/releases/latest/download/zkeenip.dat"
          GEOSITE_URL="https://github.com/jameszeroX/zkeen-domains/releases/latest/download/zkeen.dat"

          echo "[1] Скачиваем .dat файлы"
          curl -L --fail -o "$TMPDIR/zkeenip.dat"   "$GEOIP_URL"
          curl -L --fail -o "$TMPDIR/zkeen.dat"     "$GEOSITE_URL"

          echo "[2] Конвертируем .dat → текстовые списки"
          ~/go/bin/geodat2srs geoip   -i "$TMPDIR/zkeenip.dat" -o "$TMPDIR" --prefix "zkeen-ip-"
          ~/go/bin/geodat2srs geosite -i "$TMPDIR/zkeen.dat"   -o "$TMPDIR" --prefix "zkeen-site-"

          echo "[3] Генерируем настоящие бинарные .mrs (только zstd, без mihomo)"

          create_mrs() {
            local yaml_file="$1"
            local mrs_file="${yaml_file%.yaml}.mrs"
            local type="$2"  # domain или ipcidr

            [[ "$type" == "domain" ]] && type_code=1 || type_code=2

            zstd -19 --no-check -f "$yaml_file" -o "$mrs_file.zst"

            payload_size=$(wc -c < "$mrs_file.zst")

            # 16-байтовый заголовок MRS v1
            printf 'MRS\x01' > "$mrs_file"
            printf '%b' "$(printf '\\x%02x\\x00\\x00\\x00' $type_code)" >> "$mrs_file"
            # uint64 little-endian размер payload
            printf '%08x' $payload_size \
              | sed -E 's/(..)(..)(..)(..)(..)(..)(..)(..)/\\x\8\\x\7\\x\6\\x\5\\x\4\\x\3\\x\2\\x\1/' \
              | xargs printf >> "$mrs_file"

            cat "$mrs_file.zst" >> "$mrs_file"
            rm -f "$mrs_file.zst" "$yaml_file"

            echo "  $mrs_file  ($(wc -c < "$mrs_file") байт)"
          }

          # === geosite → domain ===
          for entry in "$TMPDIR"/zkeen-site-*; do
            [[ -e "$entry" ]] || continue
            category="${entry##*/zkeen-site-}"
            category="${category// /_}"
            yaml="$GEOSITE_OUTDIR/${category}.yaml"

            echo "payload:" > "$yaml"
            if [[ -d "$entry" ]]; then
              find "$entry" -type f -print0 | xargs -0 cat 2>/dev/null | grep -v '^$' | sort -u | sed 's/^/  - /' >> "$yaml"
            else
              grep -v '^$' "$entry" | sort -u | sed 's/^/  - /' >> "$yaml"
            fi

            [[ -s "$yaml" ]] && create_mrs "$yaml" domain || rm -f "$yaml"
          done

          # === geoip → ipcidr ===
          for entry in "$TMPDIR"/zkeen-ip-*; do
            [[ -e "$entry" ]] || continue
            category="${entry##*/zkeen-ip-}"
            category="${category// /_}"
            yaml="$GEOIP_OUTDIR/${category}.yaml"

            echo "payload:" > "$yaml"
            if [[ -d "$entry" ]]; then
              find "$entry" -type f -print0 | xargs -0 cat 2>/dev/null | grep -v '^$' | sort -u | sed 's/^/  - /' >> "$yaml"
            else
              grep -v '^$' "$entry" | sort -u | sed 's/^/  - /' >> "$yaml"
            fi

            [[ -s "$yaml" ]] && create_mrs "$yaml" ipcidr || rm -f "$yaml"
          done

          echo "[4] Очистка"
          rm -rf "$TMPDIR"

          echo "Готово! MRS-файлы находятся в lists/geosite/ и lists/geoip/"

      - name: Commit & Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add lists/
          git commit -m "auto: update mrs rules $(date -u +%F)" || echo "Нечего коммитить"
          git push
