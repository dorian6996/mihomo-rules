name: ZKEEN â†’ mihomo yaml

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build yaml from zkeen.dat
        run: |
          set -euo pipefail

          mkdir -p lists/geosite lists/geoip

          curl -L --fail -L -o zkeenip.dat   https://github.com/jameszeroX/zkeen-ip/releases/latest/download/zkeenip.dat
          curl -L --fail -L -o zkeen.dat     https://github.com/jameszeroX/zkeen-domains/releases/latest/download/zkeen.dat

          curl -L -o unpack https://github.com/mkcert/v2ray-geo/releases/download/2024.12.10/v2ray-geo-unpack-linux-amd64
          chmod +x unpack

          ./unpack zkeen.dat   lists/geosite
          ./unpack zkeenip.dat lists/geoip

          for txt in lists/geosite/*.txt lists/geoip/*.txt; do
            [[ -f "$txt" ]] || continue
            name=$(basename "$txt" .txt | tr '[:upper:]' '[:lower:]')
            yaml="${txt%.*}.yaml"
            echo "payload:" > "$yaml"
            sed 's/^/  - /' "$txt" >> "$yaml"
            items=$(wc -l < "$txt")
            echo "Created $yaml ($items items)"
            rm "$txt"
          done

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add lists/
          git commit -m "zkeen to yaml $(date +%F)" || echo "nothing to commit"
          git push
