name: Build MRS rulesets

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 3 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y zstd wget
          go install github.com/runetfreedom/geodat2srs@latest

      - name: Download mihomo binary and build MRS
        run: |
          #!/usr/bin/env bash
          set -euo pipefail

          ROOT="$(pwd)"
          TMPDIR="${ROOT}/tmp_dat"
          OUTDIR="${ROOT}/lists"
          GEOSITE_OUTDIR="${OUTDIR}/geosite"
          GEOIP_OUTDIR="${OUTDIR}/geoip"

          mkdir -p "$TMPDIR" "$GEOSITE_OUTDIR" "$GEOIP_OUTDIR"

          # Скачиваем .dat
          echo "[1] Download .dat files"
          curl -L --fail -o "$TMPDIR/zkeenip.dat" "https://github.com/jameszeroX/zkeen-ip/releases/latest/download/zkeenip.dat"
          curl -L --fail -o "$TMPDIR/zkeen.dat" "https://github.com/jameszeroX/zkeen-domains/releases/latest/download/zkeen.dat"

          # Конвертируем в текстовые списки
          echo "[2] Convert .dat to lists"
          ~/go/bin/geodat2srs geoip -i "$TMPDIR/zkeenip.dat" -o "$TMPDIR" --prefix "zkeen-ip-"
          ~/go/bin/geodat2srs geosite -i "$TMPDIR/zkeen.dat" -o "$TMPDIR" --prefix "zkeen-site-"

          # Скачиваем mihomo binary
          echo "[3] Download mihomo CLI binary"
          MIHOMO_VERSION="v1.19.17"
          wget -q "https://github.com/MetaCubeX/mihomo/releases/download/${MIHOMO_VERSION}/mihomo-linux-amd64-v1.19.17.gz"
          gunzip mihomo-linux-amd64-v1.19.17.gz
          chmod +x mihomo-linux-amd64-v1.19.17
          MIHOMO="./mihomo-linux-amd64-v1.19.17"

          # Фикс-тест: проверяем наличие команды в help
          if ! "$MIHOMO" help 2>&1 | grep -q "convert-ruleset"; then
            echo "Error: mihomo does not support convert-ruleset (check version)"
            exit 1
          fi
          echo "✓ mihomo CLI ready with convert-ruleset"

          # Функция для генерации .mrs из текста
          generate_mrs() {
            local text_file="$1"
            local mrs_file="$2"
            local behavior="$3"  # domain or ipcidr

            # mihomo convert-ruleset создаст yaml временно, затем mrs
            tmp_yaml="${text_file}.yaml"
            echo "payload:" > "$tmp_yaml"
            sed 's/^/  - /' "$text_file" >> "$tmp_yaml"

            "$MIHOMO" convert-ruleset "$behavior" yaml "$tmp_yaml" "$mrs_file"
            rm "$tmp_yaml"

            if [ -f "$mrs_file" ]; then
              echo "✓ Generated $mrs_file ($(wc -c < "$mrs_file") bytes)"
              # Проверяем magic (dолжен начинаться с fd 2b)
              hexdump -C "$mrs_file" | head -1 | grep "fd 2b 10"
            else
              echo "Failed to generate $mrs_file"
              exit 1
            fi
          }

          # === geosite (domain) ===
          echo "[4] Generate geosite .mrs"
          for entry in "$TMPDIR"/zkeen-site-*; do
            [[ -e "$entry" ]] || continue
            category="${entry##*/zkeen-site-}"
            category="${category%%.*}"
            category="${category// /_}"
            category="${category,,}"
            text_file="$GEOSITE_OUTDIR/${category}.txt"
            mrs_file="$GEOSITE_OUTDIR/${category}.mrs"

            # Собираем текст
            if [[ -d "$entry" ]]; then
              find "$entry" -type f -print0 | xargs -0 cat 2>/dev/null | grep -v '^$' | sort -u > "$text_file"
            else
              grep -v '^$' "$entry" | sort -u > "$text_file"
            fi

            [[ -s "$text_file" ]] && generate_mrs "$text_file" "$mrs_file" domain || rm -f "$text_file"
          done

          # === geoip (ipcidr) ===
          echo "[5] Generate geoip .mrs"
          for entry in "$TMPDIR"/zkeen-ip-*; do
            [[ -e "$entry" ]] || continue
            category="${entry##*/zkeen-ip-}"
            category="${category%%.*}"
            category="${category// /_}"
            category="${category,,}"
            text_file="$GEOIP_OUTDIR/${category}.txt"
            mrs_file="$GEOIP_OUTDIR/${category}.mrs"

            if [[ -d "$entry" ]]; then
              find "$entry" -type f -print0 | xargs -0 cat 2>/dev/null | grep -v '^$' | sort -u > "$text_file"
            else
              grep -v '^$' "$entry" | sort -u > "$text_file"
            fi

            [[ -s "$text_file" ]] && generate_mrs "$text_file" "$mrs_file" ipcidr || rm -f "$text_file"
          done

          echo "[6] Cleanup"
          rm -rf "$TMPDIR"
          echo "Done! Binary .mrs in lists/ (with zstd magic fd 2b 10)"

      - name: Commit & Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add lists/
          git commit -m "auto: update proper mrs rules $(date -u +%F)" || echo "Nothing to commit"
          git push
