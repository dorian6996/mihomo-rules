name: ZKEEN dat 2 MRS

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      GOPATH: ${{ github.workspace }}/.gopath
      GOBIN: ${{ github.workspace }}/.gopath/bin

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Prepare directories
        run: |
          mkdir -p "${GOPATH}/bin"
          mkdir -p tmp/geoip tmp/geosite 
          mkdir -p rules/geoip rules/geosite
          echo "${GOPATH}/bin" >> $GITHUB_PATH

      - name: Install v2dat tool
        run: |
          set -e
          echo "Installing v2dat..."
          go install github.com/urlesistiana/v2dat@latest
          echo "v2dat installed at:"
          which v2dat

      - name: Download ZKEEN dat files
        run: |
          set -e
          echo "Downloading geoip.dat..."
          curl -fsSL -o tmp/zkeenip.dat "https://github.com/jameszeroX/zkeen-ip/releases/latest/download/zkeenip.dat"
          
          echo "Downloading geosite.dat..."
          curl -fsSL -o tmp/zkeen.dat "https://github.com/jameszeroX/zkeen-domains/releases/latest/download/zkeen.dat"
          
          echo "File sizes:"
          ls -lh tmp/*.dat

      - name: Unpack GeoIP dat file
        run: |
          set -e
          echo "Unpacking geoip.dat..."
          if [ -f tmp/zkeenip.dat ]; then
            v2dat unpack geoip -o tmp/geoip tmp/zkeenip.dat
            echo "Unpacked geoip files:"
            ls -lh tmp/geoip/*.txt 2>/dev/null | head -5 || echo "No .txt files found"
          else
            echo "Error: zkeenip.dat not found!"
            exit 1
          fi

      - name: Unpack GeoSite dat file
        run: |
          set -e
          echo "Unpacking geosite.dat..."
          if [ -f tmp/zkeen.dat ]; then
            v2dat unpack geosite -o tmp/geosite tmp/zkeen.dat
            echo "Unpacked geosite files:"
            ls -lh tmp/geosite/*.txt 2>/dev/null | head -5 || echo "No .txt files found"
          else
            echo "Error: zkeen.dat not found!"
            exit 1
          fi

      - name: Process files and create MRS with validation
        run: |
          set -e
          echo "Processing files - creating TXT, YAML and validated MRS formats..."
          
          # Очищаем старые файлы
          rm -rf rules/geoip/* rules/geosite/* 2>/dev/null || true
          
          # === Обрабатываем GeoIP файлы ===
          echo "=== Processing GeoIP files ==="
          for f in tmp/geoip/zkeenip_*.txt; do
            if [ -f "$f" ]; then
              # Убираем префикс zkeenip_
              name=$(basename "$f" .txt | sed 's/^zkeenip_//')
              echo "Processing: $name"
              
              # 1. Сохраняем очищенный TXT файл
              grep -v '^#' "$f" | grep -v '^$' > "rules/geoip/$name.txt"
              
              if [ -s "rules/geoip/$name.txt" ]; then
                line_count=$(wc -l < "rules/geoip/$name.txt")
                echo "  ✓ TXT saved ($line_count IP rules)"
                
                # 2. Создаем YAML файл
                echo "payload:" > "rules/geoip/$name.yaml"
                cat "rules/geoip/$name.txt" | while read line; do
                  echo "  - \"$line\"" >> "rules/geoip/$name.yaml"
                done
                echo "  ✓ YAML created"
                
                # 3. Создаем MRS файл - ВАЖНО: используем синтаксис mihomo convert-ruleset domain/ipcidr text
                echo "  Creating MRS..."
                
                # Способ 1: Используем стандартный синтаксис (работает в правильной версии)
                if command -v mihomo >/dev/null 2>&1; then
                  echo "    Trying mihomo convert-ruleset ipcidr text..."
                  if mihomo convert-ruleset ipcidr text "rules/geoip/$name.txt" "rules/geoip/$name.mrs" 2>&1; then
                    # Проверяем что MRS файл валидный
                    if [ -s "rules/geoip/$name.mrs" ]; then
                      # Проверяем первые 100 байт на наличие магического числа
                      head -c 100 "rules/geoip/$name.mrs" | xxd | head -2
                      echo "    ✓ MRS created via mihomo"
                      
                      # Дополнительная проверка: пробуем прочитать файл обратно
                      echo "    Testing MRS file..."
                      if mihomo convert-ruleset --list "rules/geoip/$name.mrs" 2>&1 | head -5; then
                        echo "    ✓ MRS file is valid"
                      else
                        echo "    ⚠ MRS file may have issues"
                      fi
                    else
                      echo "    ✗ MRS file is empty"
                      rm -f "rules/geoip/$name.mrs"
                    fi
                  else
                    echo "    ✗ mihomo conversion failed"
                    rm -f "rules/geoip/$name.mrs" 2>/dev/null || true
                  fi
                else
                  echo "    ✗ mihomo not found"
                fi
              else
                echo "  ⚠ Empty file, skipping"
              fi
            fi
          done
          
          # === Обрабатываем GeoSite файлы ===
          echo ""
          echo "=== Processing GeoSite files ==="
          for f in tmp/geosite/zkeen_*.txt; do
            if [ -f "$f" ]; then
              # Убираем префикс zkeen_
              name=$(basename "$f" .txt | sed 's/^zkeen_//')
              echo "Processing: $name"
              
              # 1. Сохраняем очищенный TXT файл
              grep -v '^#' "$f" | grep -v '^$' > "rules/geosite/$name.txt"
              
              if [ -s "rules/geosite/$name.txt" ]; then
                line_count=$(wc -l < "rules/geosite/$name.txt")
                echo "  ✓ TXT saved ($line_count domain rules)"
                
                # 2. Создаем YAML файл
                echo "payload:" > "rules/geosite/$name.yaml"
                cat "rules/geosite/$name.txt" | while read line; do
                  echo "  - \"$line\"" >> "rules/geosite/$name.yaml"
                done
                echo "  ✓ YAML created"
                
                # 3. Создаем MRS файл
                echo "  Creating MRS..."
                
                # Способ 1: Используем стандартный синтаксис
                if command -v mihomo >/dev/null 2>&1; then
                  echo "    Trying mihomo convert-ruleset domain text..."
                  if mihomo convert-ruleset domain text "rules/geosite/$name.txt" "rules/geosite/$name.mrs" 2>&1; then
                    if [ -s "rules/geosite/$name.mrs" ]; then
                      echo "    ✓ MRS created via mihomo"
                    else
                      echo "    ✗ MRS file is empty"
                      rm -f "rules/geosite/$name.mrs"
                    fi
                  else
                    echo "    ✗ mihomo conversion failed"
                    rm -f "rules/geosite/$name.mrs" 2>/dev/null || true
                  fi
                else
                  echo "    ✗ mihomo not found"
                fi
              else
                echo "  ⚠ Empty file, skipping"
              fi
            fi
          done
          
          # === Пробуем альтернативный метод для MRS ===
          echo ""
          echo "=== Trying alternative MRS creation method ==="
          
          # Проверяем, какие MRS файлы создались успешно
          echo "Checking created MRS files..."
          
          # Создаем тестовый скрипт для проверки MRS
          cat > test_mrs.py << 'EOF'
          import os
          import struct
          
          def check_mrs_file(filepath):
              """Проверяет MRS файл на валидность"""
              if not os.path.exists(filepath):
                  return "File not found"
              
              try:
                  with open(filepath, 'rb') as f:
                      # Читаем первые 8 байт для проверки заголовка
                      header = f.read(8)
                      if len(header) < 8:
                          return "File too small"
                      
                      # Проверяем магическое число (обычно это 0x6D727301 для mrs v1)
                      magic = struct.unpack('<I', header[:4])[0]
                      version = struct.unpack('<I', header[4:8])[0]
                      
                      if magic == 0x6D727301:  # 'mrs\x01' в little-endian
                          return f"Valid MRS v{version}"
                      else:
                          # Попробуем прочитать как текстовый формат
                          f.seek(0)
                          first_line = f.read(100).decode('utf-8', errors='ignore')
                          if ',' in first_line and 'base64' in first_line:
                              return "Text format MRS (type,format,base64)"
                          else:
                              return f"Invalid magic: 0x{magic:X}"
              except Exception as e:
                  return f"Error: {str(e)}"
          
          # Проверяем GeoIP MRS файлы
          print("GeoIP MRS files:")
          for file in sorted(os.listdir("rules/geoip")):
              if file.endswith(".mrs"):
                  status = check_mrs_file(f"rules/geoip/{file}")
                  print(f"  {file}: {status}")
          
          print("\nGeoSite MRS files:")
          for file in sorted(os.listdir("rules/geosite")):
              if file.endswith(".mrs"):
                  status = check_mrs_file(f"rules/geosite/{file}")
                  print(f"  {file}: {status}")
          EOF
          
          python3 test_mrs.py

      - name: Create working MRS with correct tool
        run: |
          set -e
          echo "Creating MRS files with alternative method..."
          
          # Устанавливаем правильную версию mihomo для convert-ruleset
          echo "Installing mihomo from release..."
          
          # Скачиваем готовый mihomo release (вместо go install)
          MI_RELEASE_URL="https://github.com/MetaCubeX/mihomo/releases/latest/download/mihomo-linux-amd64-v3.tar.gz"
          
          echo "Downloading mihomo release..."
          curl -fsSL -o mihomo.tar.gz "$MI_RELEASE_URL" || curl -fsSL -o mihomo.tar.gz "https://github.com/MetaCubeX/mihomo/releases/latest/download/mihomo-linux-amd64.tar.gz"
          
          if [ -f mihomo.tar.gz ]; then
            tar -xzf mihomo.tar.gz
            chmod +x mihomo || chmod +x mihomo-* 2>/dev/null || true
            
            MI_BIN=$(find . -name "mihomo*" -type f -executable | head -1)
            if [ -n "$MI_BIN" ]; then
              echo "Using mihomo binary: $MI_BIN"
              
              # Пересоздаем MRS файлы с этим бинарником
              for f in rules/geoip/*.txt; do
                if [ -f "$f" ]; then
                  name=$(basename "$f" .txt)
                  echo "Recreating MRS for $name..."
                  "$MI_BIN" convert-ruleset ipcidr text "$f" "rules/geoip/$name.mrs.new" 2>&1 && mv "rules/geoip/$name.mrs.new" "rules/geoip/$name.mrs"
                fi
              done
              
              for f in rules/geosite/*.txt; do
                if [ -f "$f" ]; then
                  name=$(basename "$f" .txt)
                  echo "Recreating MRS for $name..."
                  "$MI_BIN" convert-ruleset domain text "$f" "rules/geosite/$name.mrs.new" 2>&1 && mv "rules/geosite/$name.mrs.new" "rules/geosite/$name.mrs"
                fi
              done
            fi
          fi
          
          # Если всё ещё проблемы, создаем MRS в правильном формате вручную
          echo "Creating MRS files in correct format..."
          
          cat > create_mrs.py << 'EOF'
          import os
          import base64
          import struct
          
          # Правильный заголовок для MRS v1
          MRS_MAGIC = b'mrs\x01'
          MRS_VERSION = struct.pack('<I', 1)
          
          def create_mrs_file(txt_path, mrs_path, rule_type):
              """Создает правильный MRS файл"""
              with open(txt_path, 'r', encoding='utf-8') as f:
                  content = f.read().strip()
              
              if not content:
                  print(f"Empty file: {txt_path}")
                  return False
              
              # Кодируем в base64
              encoded = base64.b64encode(content.encode('utf-8')).decode('utf-8')
              
              # Формируем содержимое в правильном формате
              # Формат: type,format,base64_data
              mrs_content = f"{rule_type},text,{encoded}"
              
              # Создаем бинарный MRS файл с правильным заголовком
              with open(mrs_path, 'wb') as f:
                  # Заголовок
                  f.write(MRS_MAGIC)
                  f.write(MRS_VERSION)
                  
                  # Данные
                  f.write(mrs_content.encode('utf-8'))
              
              print(f"Created {mrs_path}")
              return True
          
          # Создаем GeoIP MRS файлы
          print("Creating GeoIP MRS files...")
          for file in os.listdir("rules/geoip"):
              if file.endswith(".txt"):
                  name = file[:-4]
                  txt_path = f"rules/geoip/{file}"
                  mrs_path = f"rules/geoip/{name}.mrs"
                  
                  # Пересоздаем если файл не существует или имеет проблемы
                  if not os.path.exists(mrs_path) or os.path.getsize(mrs_path) < 10:
                      create_mrs_file(txt_path, mrs_path, "ipcidr")
          
          # Создаем GeoSite MRS файлы
          print("\nCreating GeoSite MRS files...")
          for file in os.listdir("rules/geosite"):
              if file.endswith(".txt"):
                  name = file[:-4]
                  txt_path = f"rules/geosite/{file}"
                  mrs_path = f"rules/geosite/{name}.mrs"
                  
                  if not os.path.exists(mrs_path) or os.path.getsize(mrs_path) < 10:
                      create_mrs_file(txt_path, mrs_path, "domain")
          
          print("\nDone!")
          EOF
          
          python3 create_mrs.py

      - name: Final validation and commit
        run: |
          set -e
          echo "=== Final validation ==="
          echo "Created files:"
          echo "GeoIP: $(find rules/geoip -name "*.mrs" -type f 2>/dev/null | wc -l) MRS files"
          echo "GeoSite: $(find rules/geosite -name "*.mrs" -type f 2>/dev/null | wc -l) MRS files"
          
          # Создаем файлы для тестирования
          echo "Creating test files..."
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add rules/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update rules with validated MRS format [$(date +'%Y-%m-%d %H:%M')]"
            git push
            echo "Changes pushed successfully"
          fi
